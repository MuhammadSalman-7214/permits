<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Permit Search</title>

    <style>
      * {
        box-sizing: border-box;
      }
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #4b79a1, #283e51);
      }
      /* body {
        margin: 0;
        padding: 50px 20px;
        background: linear-gradient(135deg, #4b79a1, #283e51);
        display: flex;
        justify-content: center;
        font-family: "Inter", Arial, sans-serif;
        position: relative;
      } */

      .wrapper {
        width: 100%;
        max-width: 460px;
      }

      h2 {
        text-align: center;
        font-size: 26px;
        margin-bottom: 24px;
        color: #fff;
      }

      .form-card {
        padding: 28px;
        border-radius: 18px;
        background: #ffffff26;
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 25px #00000040;
        animation: fadeIn 0.6s ease-in-out;
        border: 1px solid #ffffff4d;
        border-radius: 18px;
        transition: all 0.3s ease;
      }
      .form-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 28px #00000029, 0 6px 14px #00000014;
      }

      label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        display: block;
        color: #000;
      }

      input,
      select {
        width: 100%;
        height: 46px;
        padding: 0 14px;
        border-radius: 8px;
        border: 1px solid #51504f;
        background-color: transparent;
        margin-bottom: 18px;
        font-size: 15px;
        color: #202120;
      }

      input:focus,
      select:focus {
        border-color: #2f81f7;
        box-shadow: 0 0 0 3px #2f81f740;
        outline: none;
      }
      /* ‚úÖ Better-looking select box */
      select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;

        width: 100%;
        height: 46px;
        padding: 0 14px;
        border-radius: 8px;
        border: 1px solid #51504f;
        background: transparent
          url('data:image/svg+xml;utf8,<svg fill="gray" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>')
          no-repeat right 12px center;
        font-size: 15px;
        cursor: pointer;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      select:focus {
        border-color: #2f81f7;
        box-shadow: 0 0 0 3px #2f81f740;
        outline: none;
      }

      select option {
        padding: 12px;
        font-size: 15px;
        border-radius: 6px;
      }

      select option:hover {
        background: #e7f0ff !important;
      }
      select option:checked {
        background: #dbe7ff !important;
        font-weight: 600;
      }

      select::-webkit-dropdown {
        border-radius: 10px;
        box-shadow: 0 6px 22px #0000001f;
      }

      button {
        width: 100%;
        height: 48px;
        background: #2f81f7;
        color: white;
        border: none;
        border-radius: 9px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .logout-btn {
        position: fixed;
        top: 180px;
        right: 0px;
        background: transparent;
        backdrop-filter: blur(12px);
        border-style: solid none solid solid;
        border-width: 2px;
        border-color: #2f81f7;
        color: #fff;
        border-radius: 30px 0 0 0;
        font-size: 20px;
        text-align: center;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 6px 26px #0000002e, 0 2px 8px #00000014;
        transition: all 0.25s ease-in-out;
        z-index: 100;
        width: 300px;
        padding: 12px 20px;
        text-decoration: none;
      }

      /* .logout-btn:hover {
        background: #d9534f;
        color: white;
        border-color: #fc6203;
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 10px 30px #d9534f73, 0 4px 14px #00000026;
      } */

      /* ‚úÖ Success & Error Bars */
      .msg-bar {
        display: none;
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 15px;
        margin-bottom: 16px;
        font-weight: 600;
      }

      .success-bar {
        background: #d4f8d2;
        color: #1b5e20;
        border-left: 5px solid #43a047;
      }

      .error-bar {
        background: #ffe1e1;
        color: #b30000;
        border-left: 5px solid #d32f2f;
      }

      .spinner {
        display: inline-flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 25px; /* adds space from button */
        /* width: 100%; */
        text-align: center;
      }

      .spinner div {
        width: 13px;
        height: 13px;
        background: #2f81f7;
        border-radius: 50%;
        animation: bounce 0.6s infinite ease-in-out;
        display: inline-block;
      }

      .spinner div:nth-child(2) {
        animation-delay: 0.15s;
      }

      .spinner div:nth-child(3) {
        animation-delay: 0.3s;
      }

      @keyframes bounce {
        0% {
          transform: translateY(0);
          opacity: 0.5;
        }
        50% {
          transform: translateY(-10px);
          opacity: 1;
        }
        100% {
          transform: translateY(0);
          opacity: 0.5;
        }
      }
    </style>
  </head>

  <body>
    <a id="logoutBtn" class="logout-btn">Log Out</a>
    <div class="wrapper">
      <a
        href="/refresh-kirkland"
        target="_blank"
        style="
          position: fixed;
          top: 100px;
          right: 0px;
          background: transparent;
          backdrop-filter: blur(12px);
          border-style: solid none solid solid;
          border-width: 2px;
          border-color: #2f81f7;
          color: #fff;
          border-radius: 30px 0 0 0;
          font-size: 20px;
          text-align: center;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 6px 26px #0000002e, 0 2px 8px #00000014;
          transition: all 0.25s ease-in-out;
          z-index: 100;
          width: 300px;
          padding: 12px 20px;
          text-decoration: none;
        "
      >
        Refresh Kirkland Data
      </a>
      <a
        href="/refresh-burien"
        target="_blank"
        style="
          position: fixed;
          top: 20px;
          right: 0px;
          background: transparent;
          backdrop-filter: blur(12px);
          border-style: solid none solid solid;
          border-width: 2px;
          border-color: #2f81f7;
          color: #fff;
          border-radius: 30px 0 0 0;
          font-size: 20px;
          text-align: center;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 6px 26px #0000002e, 0 2px 8px #00000014;
          transition: all 0.25s ease-in-out;
          z-index: 100;
          width: 300px;
          padding: 12px 20px;
          text-decoration: none;
        "
      >
        Refresh Burien Data
      </a>
      <h2>üîç Permit Search Filters</h2>

      <!-- ‚úÖ Message bar (success or error) -->
      <div id="msgBar" class="msg-bar"></div>

      <form id="permitForm" class="form-card">
        <label>City / Jurisdiction *</label>
        <select name="city" required>
          <option value="">Any</option>
          <!-- <option value="Auburn">Auburn</option> -->
          <option value="Bellevue">Bellevue</option>
          <option value="Bothell">Bothell</option>
          <option value="Burien">Burien</option>
          <option value="Kirkland">Kirkland</option>
        </select>

        <label>Start Date *</label>
        <input type="date" name="startDate" required />

        <label>End Date *</label>
        <input type="date" name="endDate" required />
        <button type="submit">Search Permits ‚úÖ</button>

        <!-- ‚úÖ Spinner -->
        <!-- <div class="spinner" id="spinner"></div> -->
        <div class="spinner" id="spinner" style="display: none">
          <div></div>
          <div></div>
          <div></div>
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("permitForm");
      const msgBar = document.getElementById("msgBar");
      const spinner = document.getElementById("spinner");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const start = new Date(form.startDate.value);
        const end = new Date(form.endDate.value);
        if (start > end) {
          msgBar.innerText = "‚ùå Start date must be before end date";
          msgBar.className = "msg-bar error-bar";
          msgBar.style.display = "block";
          return;
        }
        msgBar.style.display = "none";
        const btn = form.querySelector("button");
        btn.disabled = true;
        spinner.style.display = "block";

        const formData = new FormData(form);
        const body = {};
        formData.forEach((v, k) => (body[k] = v));

        const res = await fetch("/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          spinner.style.display = "none";
          btn.disabled = false;

          let errorMsg = "Server error";

          try {
            const err = await res.json();
            if (err.message) errorMsg = err.message;
          } catch (e) {}

          msgBar.innerText = "‚ùå " + errorMsg;
          msgBar.className = "msg-bar error-bar";
          msgBar.style.display = "block";
          return;
        }
        const contentDisposition = res.headers.get("Content-Disposition");
        let filename = "permits.xlsx"; // Fallback default
        if (contentDisposition) {
          const match = contentDisposition.match(/filename="([^"]+)"/);
          if (match && match[1]) {
            filename = match[1];
          }
        }
        // ‚úÖ Read as Excel file (Blob)
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);

        // ‚úÖ Trigger download
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();

        spinner.style.display = "none";
        btn.disabled = false;

        msgBar.innerText = "‚úÖ Excel file downloaded!";
        msgBar.className = "msg-bar success-bar";
        msgBar.style.display = "block";

        setTimeout(() => (msgBar.style.display = "none"), 3000);
      });

      const logoutBtn = document.getElementById("logoutBtn");

      logoutBtn.addEventListener("click", async () => {
        const res = await fetch("/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });

        const data = await res.json();

        if (data.success && data.redirect) {
          window.location.href = data.redirect; // redirect to login
        }
      });
    </script>
  </body>
</html>
