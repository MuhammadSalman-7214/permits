<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Permit Search</title>

    <style>
      * {
        box-sizing: border-box;
      }
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #4b79a1, #283e51);
      }

      .wrapper {
        width: 100%;
        max-width: 460px;
      }
      h2 {
        text-align: center;
        font-size: 26px;
        margin-bottom: 24px;
        color: #fff;
      }

      .form-card {
        padding: 28px;
        border-radius: 18px;
        background: #ffffff26;
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 25px #00000040;
        border: 1px solid #ffffff4d;
        transition: all 0.3s ease;
      }

      label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        display: block;
        color: #000;
      }

      input,
      select {
        width: 100%;
        height: 46px;
        padding: 0 14px;
        border-radius: 8px;
        border: 1px solid #51504f;
        background-color: transparent;
        margin-bottom: 18px;
        font-size: 15px;
        color: #202120;
      }

      input:focus,
      select:focus {
        border-color: #2f81f7;
        box-shadow: 0 0 0 3px #2f81f740;
        outline: none;
      }

      select {
        appearance: none;
        background: transparent
          url('data:image/svg+xml;utf8,<svg fill="gray" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>')
          no-repeat right 12px center;
        cursor: pointer;
      }

      button {
        width: 100%;
        height: 48px;
        background: #2f81f7;
        color: white;
        border: none;
        border-radius: 9px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .logout-btn {
        position: fixed;
        top: 340px;
        right: 0px;
        background: transparent;
        backdrop-filter: blur(12px);
        border-style: solid none solid solid;
        border-width: 2px;
        border-color: #2f81f7;
        color: #fff;
        border-radius: 30px 0 0 0;
        font-size: 20px;
        text-align: center;
        font-weight: 600;
        cursor: pointer;
        width: 300px;
        padding: 12px 20px;
        text-decoration: none;
        z-index: 100;
      }

      .msg-bar {
        display: none;
        padding: 12px 16px;
        border-radius: 6px;
        font-size: 15px;
        margin-bottom: 16px;
        font-weight: 600;
      }
      .success-bar {
        background: #d4f8d2;
        color: #1b5e20;
        border-left: 5px solid #43a047;
      }
      .error-bar {
        background: #ffe1e1;
        color: #b30000;
        border-left: 5px solid #d32f2f;
      }
      .side-nav-btn {
        transition: all 0.3s ease;
      }

      .side-nav-btn:hover {
        background: rgba(47, 129, 247, 0.2) !important;
        border-color: #38bdf8 !important;
        color: #38bdf8 !important;
        padding-right: 40px !important; /* Slight movement to show it's active */
      }
      /* --- UPDATED SMOOTH PROGRESS UI --- */

      #progressArea {
        margin-top: 25px;
        padding: 22px;
        background: rgba(15, 23, 42, 0.6); /* Darker professional slate */
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      }

      .progress-label-container {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 12px;
      }

      #progressStatus {
        font-size: 13px;
        color: #cbd5e1;
        font-weight: 400;
        font-style: italic;
      }

      #progressPercent {
        font-size: 24px;
        color: #38bdf8;
        font-weight: 800;
        font-family: "Monaco", monospace;
        line-height: 1;
      }

      .progress-container {
        width: 100%;
        height: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.3);
      }

      .progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #2f81f7, #06b6d4, #2f81f7);
        background-size: 200% 100%;
        border-radius: 20px;
        /* Reduced from 0.3s to 0.1s to make it feel more "live" and snappy */
        transition: width 0.1s linear;
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        animation: flow 2s linear infinite;
      }
      @keyframes flow {
        0% {
          background-position: 0% 50%;
        }
        100% {
          background-position: 200% 50%;
        }
      }
      .pulse {
        animation: pulse-glow 1.5s infinite ease-in-out;
      }
      @keyframes pulse-glow {
        0%,
        100% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(1.4);
        }
      }
      /* Shared styling for all side buttons */

      /* Specific Top positions */
      #refreshBellevueBtn {
        top: 20px;
      }
      #refreshBothellBtn {
        top: 100px;
      }
      [href="/refresh-kirkland"] {
        top: 180px;
      }
      [href="/refresh-burien"] {
        top: 260px;
      }

      /* Hover Effect for Button */
      .side-nav-btn:hover {
        background: #2f81f7;
        width: 280px; /* Slight expansion */
        box-shadow: -5px 0 20px rgba(47, 129, 247, 0.4);
      }

      /* Position the Logout button separately from the refresh buttons */
      .logout-pos {
        top: 340px; /* Positions it below the Burien button */
        border-color: #ef4444; /* Red border to indicate 'action' */
      }

      /* Specific Hover Effect for Logout (Red instead of Blue) */
      .logout-pos:hover {
        background: #ef4444 !important;
        border-color: #f87171 !important;
        box-shadow: -5px 0 20px rgba(239, 68, 68, 0.4) !important;
      }

      /* Tooltip specifically for Logout (Red accent) */
      .logout-pos::after {
        color: #fca5a5; /* Light red text for the logout tooltip */
        border-color: rgba(239, 68, 68, 0.3);
      }

      /* REUSE your existing side-nav-btn CSS from the previous step here */
      .side-nav-btn {
        position: fixed;
        right: 0px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        border: 2px solid #2f81f7;
        border-right: none;
        color: #fff;
        border-radius: 30px 0 0 30px;
        font-size: 16px;
        text-align: center;
        font-weight: 600;
        cursor: pointer;
        width: 260px;
        padding: 12px 20px;
        text-decoration: none;
        z-index: 100;
        transition: all 0.3s ease;
      }

      .side-nav-btn::after {
        content: attr(data-tooltip);
        position: absolute;
        right: 110%;
        top: 50%;
        transform: translateY(-50%) scale(0.8);
        background: #1e293b;
        color: #38bdf8;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 400;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s ease;
        border: 1px solid rgba(56, 189, 248, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .side-nav-btn:hover::after {
        opacity: 1;
        transform: translateY(-50%) scale(1);
      }
    </style>
  </head>

  <body>
    <a
      id="logoutBtn"
      class="side-nav-btn logout-pos"
      data-tooltip="Sign out and end your current session"
    >
      Log Out
    </a>
    <div class="wrapper">
      <a
        id="refreshBellevueBtn"
        class="side-nav-btn"
        data-tooltip="Sync local database with live government records"
      >
        Refresh Bellevue Data
      </a>

      <a
        id="refreshBothellBtn"
        class="side-nav-btn"
        data-tooltip="Sync local database with live government records"
      >
        Refresh Bothell Data
      </a>

      <a
        href="/refresh-kirkland"
        target="_blank"
        class="side-nav-btn"
        data-tooltip="Sync local database with live government records"
      >
        Refresh Kirkland Data
      </a>

      <a
        href="/refresh-burien"
        target="_blank"
        class="side-nav-btn"
        data-tooltip="Sync local database with live government records"
      >
        Refresh Burien Data
      </a>

      <h2>üîç Permit Search Filters</h2>
      <div id="msgBar" class="msg-bar"></div>

      <form id="permitForm" class="form-card">
        <label>City / Jurisdiction *</label>
        <select name="city" required>
          <option value="">Any</option>
          <option value="Bellevue">Bellevue</option>
          <option value="Bothell">Bothell</option>
          <option value="Burien">Burien</option>
          <option value="Kirkland">Kirkland</option>
        </select>

        <label>Start Date *</label>
        <input type="date" name="startDate" required />

        <label>End Date *</label>
        <input type="date" name="endDate" required />
        <button type="submit">Search Permits ‚úÖ</button>

        <div id="progressArea" style="display: none">
          <div class="progress-label-container">
            <div id="progressStatus">Establishing data stream...</div>
            <div id="progressPercent">0%</div>
          </div>
          <div class="progress-container">
            <div id="progressFill" class="progress-fill"></div>
          </div>
        </div>
      </form>
    </div>

    <script>
      const form = document.getElementById("permitForm");
      const msgBar = document.getElementById("msgBar");

      function displayMsg(message, type = "success") {
        msgBar.innerText = message;
        msgBar.className =
          "msg-bar " + (type === "error" ? "error-bar" : "success-bar");
        msgBar.style.display = "block";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const start = new Date(form.startDate.value);
        const end = new Date(form.endDate.value);
        const city = form.city.value;

        if (start > end) {
          displayMsg("‚ùå Start date must be before end date", "error");
          return;
        }

        msgBar.style.display = "none";
        const btn = form.querySelector("button");
        const progressArea = document.getElementById("progressArea");
        const progressFill = document.getElementById("progressFill");
        const progressStatus = document.getElementById("progressStatus");
        const progressPercent = document.getElementById("progressPercent");

        btn.disabled = true;
        progressArea.style.display = "block";

        const eventSource = new EventSource("/progress");
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.status === "fetching") {
            const percent = ((data.current / data.total) * 100).toFixed(1);
            progressFill.style.width = percent + "%";
            progressPercent.innerText = Math.round(percent) + "%";
            progressStatus.innerText = `‚ö° Processing permit ${data.current.toLocaleString()} of ${data.total.toLocaleString()}`;
          } else if (data.status === "generating") {
            progressFill.style.width = "100%";
            progressFill.style.background =
              "linear-gradient(90deg, #f59e0b, #fbbf24)";
            progressFill.classList.add("pulse");
            progressStatus.innerText = "üìã Packing Excel Report...";
            progressPercent.innerText = "99%";
          }
        };

        try {
          const res = await fetch("/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(Object.fromEntries(new FormData(form))),
          });

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            const serverMsg = errorData.message;
            if (res.status === 404)
              throw new Error(serverMsg || "No permits found for that range.");
            if (res.status === 400)
              throw new Error(serverMsg || "Please check your inputs.");
            if (res.status === 401)
              throw new Error("Session expired. Please log in again.");

            throw new Error("Something went wrong. Please try again.");
          }
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          displayMsg(
            "‚ú® Your report is ready! The download should start automatically."
          );
          const a = document.createElement("a");
          a.href = url;
          a.download = `Permit_Report_${city}.xlsx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (err) {
          let friendlyMsg = err.message;
          if (friendlyMsg === "Failed to fetch") {
            friendlyMsg =
              "Lost connection to the server. Please check your internet.";
          }
          displayMsg("‚ö†Ô∏è " + friendlyMsg, "error");
        } finally {
          eventSource.close();
          btn.disabled = false;
          progressArea.style.display = "none";
          progressFill.classList.remove("pulse");
        }
      });

      // API Button Handlers
      const handleApi = async (btn, url, name) => {
        const originalText = btn.innerText;
        btn.innerText = `Fetching ${name}...`;
        btn.disabled = true;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (data.success) {
            displayMsg(
              `üéâ Success! We've updated the records for ${name}. (${data.count} found)`
            );
          } else {
            displayMsg(
              `üìÇ We couldn't update ${name} right now: ${data.message}`,
              "error"
            );
          }
        } catch {
          displayMsg(
            `üåê Connection issue: Couldn't reach the ${name} data source.`,
            "error"
          );
        } finally {
          btn.innerText = originalText;
          btn.disabled = false;
        }
      };

      document.getElementById("refreshBellevueBtn").onclick = (e) =>
        handleApi(e.target, "/api/bellevue", "Bellevue");
      document.getElementById("refreshBothellBtn").onclick = (e) =>
        handleApi(e.target, "/api/bothell", "Bothell");
      document.getElementById("logoutBtn").onclick = async () => {
        const res = await fetch("/logout", { method: "POST" });
        const data = await res.json();
        if (data.success) window.location.href = data.redirect;
      };
    </script>
  </body>
</html>
