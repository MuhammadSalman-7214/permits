<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Refresh Kirkland Permit Data</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.28/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
      /* reuse your Burien styling (keeps UX consistent) */
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .spinner {
        margin: 30px auto;
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Refreshing Kirkland Permit Data</h2>
      <p>Map is loading... please wait ~15-25 seconds</p>
      <div class="spinner"></div>
      <div id="status">Connecting to ArcGIS...</div>
      <div
        id="viewDiv"
        style="
          width: 100%;
          height: 70vh;
          margin-top: 20px;
          border: 2px solid #ddd;
          border-radius: 10px;
        "
      ></div>
    </div>

    <script>
      document.getElementById("status").textContent = "Map loading...";
      require(["esri/WebMap", "esri/views/MapView"], function (
        WebMap,
        MapView
      ) {
        const webmap = new WebMap({
          portalItem: { id: "b828f9a668d6450ea1a5564a39f9d51a" }, // <-- Kirkland webmap id
        });

        const view = new MapView({ container: "viewDiv", map: webmap });
        view.when(() => {
          document.getElementById("status").textContent =
            "Map loaded. Querying permits...";
          // Find the layer by name — change the text below if your permit layer has a different title
          //   const layer = webmap.layers.find((l) =>
          //     /permit|service|ticket/i.test(l.title || "")
          //   );
          const layer = webmap.layers.find((l) =>
            l.title.includes("BRW_Energov_Ext")
          );
          if (!layer) {
            document.getElementById("status").innerHTML =
              "<span style='color:red'>Permit layer not found — open the map, find the layer title and update this script.</span>";
            return;
          }

          layer.load().then(() => {
            layer
              .queryFeatures({
                where: "1=1",
                outFields: ["*"],
                returnGeometry: false,
                resultRecordCount: 32000,
              })
              .then((result) => {
                const data = result.features.map((f) => f.attributes);
                document.getElementById(
                  "status"
                ).textContent = `Saving ${data.length} records...`;

                fetch("/save-kirkland-json", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(data),
                })
                  .then(() => {
                    window.location.href = "/permit";
                  })
                  .catch(() => {
                    document.getElementById("status").innerHTML =
                      "<span style='color:red'>Save failed! Try again.</span>";
                  });
              })
              .catch((err) => {
                document.getElementById(
                  "status"
                ).innerHTML = `<span style='color:red'>Query failed: ${
                  err.message || err
                }</span>`;
              });
          });
        });
      });
    </script>
  </body>
</html>
